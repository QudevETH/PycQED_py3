variables:
  # Variables set in the GitLab UI are not passed down to service containers.
  QUDEV_DOC_PRIVATE_SSH_KEY: $QUDEV_DOC_PRIVATE_SSH_KEY
  CI_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

stages:
  - ci_image_build # Create Docker image to speed up CI pipelines
  - documentation # Compile Sphinx documentation
  - test # Run unit tests, etc.
  - deploy # TODO: deploy as pip package

# build_docker_image:
ci_image:
  image: docker:20.10.12
  stage: ci_image_build
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  services:
    - name: docker:20.10.12-dind
      alias: docker
  script:
    - docker --version
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY/qudev --username $CI_REGISTRY_USER --password-stdin
    - echo "Sucessfully logged into QuDev's GitLab container registry."
    - docker build -t $CI_IMAGE_NAME .
    - docker push $CI_IMAGE_NAME
  only:
    refs:
      - branches
    changes:
      - Dockerfile
      - requirements.txt
      - .gitlab-ci.yml

# Build the documentation, and copy it to the QuDev documentation webshare
pages:
  image: $CI_IMAGE_NAME
  script:
    - cd docs
    - make html
    # Using ${CI_PROJECT_PATH:6} to trim "qudev/" at beginning of the path
    - DOC_UPLOAD_FOLDER=${CI_PROJECT_PATH:6}/$CI_COMMIT_BRANCH
    - ssh wwwqudevdoc@documentation.qudev.phys.ethz.ch "mkdir -p public/$DOC_UPLOAD_FOLDER"
    - ssh wwwqudevdoc@documentation.qudev.phys.ethz.ch "rm -rf public/$DOC_UPLOAD_FOLDER/*"
    - scp -r ./build/html/* "wwwqudevdoc@documentation.qudev.phys.ethz.ch:public/$DOC_UPLOAD_FOLDER"
    - echo "Documentation accessible at https://documentation.qudev.phys.ethz.ch/$DOC_UPLOAD_FOLDER/index.html"
  # only:
  #   # The documentation will only be built for the listed branches
  #   - qudev_master
  #   - /^Proj\/.*$/
  #   - /^doc\/.*$/
